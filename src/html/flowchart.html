<!DOCTYPE html>
<html>
<head>
    <title>Flowchart</title>
    <meta name="description" content="Interactive flowchart diagram implemented by GoJS in JavaScript for HTML."/>
    <meta charset="UTF-8">
    <!--<link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">-->
    <link rel="stylesheet" href="https://cdn.bootcss.com/element-ui/2.1.0/theme-chalk/index.css">
    <style>
        #sample .el-dialog__wrapper .el-dialog {
            width: 80%
        }
    </style>
    <!-- 先引入 Vue -->
    <script src="../js/lib/vue.js"></script>
    <!-- 引入组件库 -->
    <script src="../js/lib/element-ui.js"></script>
    <script src="../js/lib/go-debug.js"></script>
    <script id="code">
        function init() {
            window.myVue = new Vue({
                el: '#sample',
                data: function () {
                    return {
                        outerVisible: true,
                        dialogFormVisible: false,
                        form: {
                            command: '',
                            jobName: '',
                            region: ''
                        },
                        formLabelWidth: '120px',
                        rules: {
                            command: {type: 'string', required: true, message: '请选择', trigger: 'change'},
                            shFile: {required: true, message: '请选择', trigger: 'change'}
                        }
                    }
                },
                mounted: function () {
                    console.log('mounted')
//                    this.outerVisible = true
                },
                methods: {}
            })
            Vue.nextTick(function () {
                var MAKE = go.GraphObject.make;  // for conciseness in defining templates
                myDiagram =
                    MAKE(go.Diagram, "myDiagramDiv",  // must name or refer to the DIV HTML element
                        {
                            initialContentAlignment: go.Spot.Center,
                            allowDrop: true,  // must be true to accept drops from the Palette
                            "LinkDrawn": showLinkLabel,  // this DiagramEvent listener is defined below
                            "LinkRelinked": showLinkLabel,
                            "animationManager.duration": 800, // slightly longer than default (600ms) animation
                            "undoManager.isEnabled": true  // enable undo & redo
                        });
                // when the document is modified, add a "*" to the title and enable the "Save" button
                myDiagram.addDiagramListener("Modified", function (e) {
                    var button = document.getElementById("SaveButton");
                    if (button) button.disabled = !myDiagram.isModified;
                    var idx = document.title.indexOf("*");
                    if (myDiagram.isModified) {
                        if (idx < 0) document.title += "*";
                    } else {
                        if (idx >= 0) document.title = document.title.substr(0, idx);
                    }
                });
                // helper definitions for node templates
                function nodeStyle() {
                    return [
                        // The Node.location comes from the "loc" property of the node data,
                        // converted by the Point.parse static method.
                        // If the Node.location is changed, it updates the "loc" property of the node data,
                        // converting back using the Point.stringify static method.
                        new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                        {
                            // the Node.location is at the center of each node
                            locationSpot: go.Spot.Center,
                            //isShadowed: true,
                            //shadowColor: "#888",
                            // handle mouse enter/leave events to show/hide the ports
                            mouseEnter: function (e, obj) {
                                showPorts(obj.part, true);
                            },
                            mouseLeave: function (e, obj) {
                                showPorts(obj.part, false);
                            },
                            doubleClick: function (e, obj) {
                                console.log(obj.data)
                                console.log(obj.data.key)
                                console.log(obj.data.text)
                                console.log('doubleClick')
//                            window.myVue.$message('message')
                                window.myVue.form.jobName = obj.data.text
                                window.myVue.dialogFormVisible = true
                            }
                        }
                    ];
                }

                // Define a function for creating a "port" that is normally transparent.
                // The "name" is used as the GraphObject.portId, the "spot" is used to control how links connect
                // and where the port is positioned on the node, and the boolean "output" and "input" arguments
                // control whether the user can draw links from or to the port.
                function makePort(name, spot, output, input) {
                    // the port is basically just a small circle that has a white stroke when it is made visible
                    return MAKE(go.Shape, "Circle",
                        {
                            fill: "transparent",
                            stroke: null,  // this is changed to "white" in the showPorts function
                            desiredSize: new go.Size(8, 8),
                            alignment: spot, alignmentFocus: spot,  // align the port on the main Shape
                            portId: name,  // declare this object to be a "port"
                            fromSpot: spot, toSpot: spot,  // declare where links may connect at this port
                            fromLinkable: output, toLinkable: input,  // declare whether the user may draw links to/from here
                            cursor: "pointer"  // show a different cursor to indicate potential link point
                        });
                }

                // define the Node templates for regular nodes
                var lightText = 'whitesmoke';
                myDiagram.nodeTemplateMap.add("",  // the default category
                    MAKE(go.Node, "Spot", nodeStyle(),
                        // the main object is a Panel that surrounds a TextBlock with a rectangular Shape
                        MAKE(go.Panel, "Auto",
                            MAKE(go.Shape, "Rectangle",
                                {fill: "#00A9C9", stroke: null},
                                new go.Binding("figure", "figure")),
                            MAKE(go.TextBlock,
                                {
                                    font: "bold 11pt Helvetica, Arial, sans-serif",
                                    stroke: lightText,
                                    margin: 8,
                                    maxSize: new go.Size(160, NaN),
                                    wrap: go.TextBlock.WrapFit,
//                                    editable: true
                                    editable: false
                                },
                                new go.Binding("text").makeTwoWay())
                        ),
                        // four named ports, one on each side:
                        makePort("T", go.Spot.Top, false, true),
                        makePort("L", go.Spot.Left, true, true),
                        makePort("R", go.Spot.Right, true, true),
                        makePort("B", go.Spot.Bottom, true, false)
                    ));
                myDiagram.nodeTemplateMap.add("Start",
                    MAKE(go.Node, "Spot", nodeStyle(),
                        MAKE(go.Panel, "Auto",
                            MAKE(go.Shape, "Circle",
                                {minSize: new go.Size(40, 40), fill: "#79C900", stroke: null}),
                            MAKE(go.TextBlock, "Start",
                                {font: "bold 11pt Helvetica, Arial, sans-serif", stroke: lightText},
                                new go.Binding("text"))
                        ),
                        // three named ports, one on each side except the top, all output only:
                        makePort("L", go.Spot.Left, true, false),
                        makePort("R", go.Spot.Right, true, false),
                        makePort("B", go.Spot.Bottom, true, false)
                    ));
                myDiagram.nodeTemplateMap.add("End",
                    MAKE(go.Node, "Spot", nodeStyle(),
                        MAKE(go.Panel, "Auto",
                            MAKE(go.Shape, "Circle",
                                {minSize: new go.Size(40, 40), fill: "#DC3C00", stroke: null}),
                            MAKE(go.TextBlock, "End",
                                {font: "bold 11pt Helvetica, Arial, sans-serif", stroke: lightText},
                                new go.Binding("text"))
                        ),
                        // three named ports, one on each side except the bottom, all input only:
                        makePort("T", go.Spot.Top, false, true),
                        makePort("L", go.Spot.Left, false, true),
                        makePort("R", go.Spot.Right, false, true)
                    ));
                myDiagram.nodeTemplateMap.add("Comment",
                    MAKE(go.Node, "Auto", nodeStyle(),
                        MAKE(go.Shape, "File",
                            {fill: "#EFFAB4", stroke: null}),
                        MAKE(go.TextBlock,
                            {
                                margin: 5,
                                maxSize: new go.Size(200, NaN),
                                wrap: go.TextBlock.WrapFit,
                                textAlign: "center",
                                editable: true,
                                font: "bold 12pt Helvetica, Arial, sans-serif",
                                stroke: '#454545'
                            },
                            new go.Binding("text").makeTwoWay())
                        // no ports, because no links are allowed to connect with a comment
                    ));
                // replace the default Link template in the linkTemplateMap
                myDiagram.linkTemplate =
                    MAKE(go.Link,  // the whole link panel
                        {
                            routing: go.Link.AvoidsNodes,
                            curve: go.Link.JumpOver,
                            corner: 5, toShortLength: 4,
                            relinkableFrom: true,
                            relinkableTo: true,
                            reshapable: true,
                            resegmentable: true,
                            // mouse-overs subtly highlight links:
                            mouseEnter: function (e, link) {
                                link.findObject("HIGHLIGHT").stroke = "rgba(30,144,255,0.2)";
                            },
                            mouseLeave: function (e, link) {
                                link.findObject("HIGHLIGHT").stroke = "transparent";
                            }
                        },
                        new go.Binding("points").makeTwoWay(),
                        MAKE(go.Shape,  // the highlight shape, normally transparent
                            {isPanelMain: true, strokeWidth: 8, stroke: "transparent", name: "HIGHLIGHT"}),
                        MAKE(go.Shape,  // the link path shape
                            {isPanelMain: true, stroke: "gray", strokeWidth: 2}),
                        MAKE(go.Shape,  // the arrowhead
                            {toArrow: "standard", stroke: null, fill: "gray"}),
                        MAKE(go.Panel, "Auto",  // the link label, normally not visible
                            {visible: false, name: "LABEL", segmentIndex: 2, segmentFraction: 0.5},
                            new go.Binding("visible", "visible").makeTwoWay(),
                            MAKE(go.Shape, "RoundedRectangle",  // the label shape
                                {fill: "#F8F8F8", stroke: null}),
                            MAKE(go.TextBlock, "Yes",  // the label
                                {
                                    textAlign: "center",
                                    font: "10pt helvetica, arial, sans-serif",
                                    stroke: "#333333",
                                    editable: true
                                },
                                new go.Binding("text").makeTwoWay())
                        )
                    );
                // Make link labels visible if coming out of a "conditional" node.
                // This listener is called by the "LinkDrawn" and "LinkRelinked" DiagramEvents.
                function showLinkLabel(e) {
                    var label = e.subject.findObject("LABEL");
                    if (label !== null) label.visible = (e.subject.fromNode.data.figure === "Diamond");
                }

                // temporary links used by LinkingTool and RelinkingTool are also orthogonal:
                myDiagram.toolManager.linkingTool.temporaryLink.routing = go.Link.Orthogonal;
                myDiagram.toolManager.relinkingTool.temporaryLink.routing = go.Link.Orthogonal;
                load();  // load an initial diagram from some JSON text
                // initialize the Palette that is on the left side of the page
                myPalette =
                    MAKE(go.Palette, "myPaletteDiv",  // must name or refer to the DIV HTML element
                        {
                            "animationManager.duration": 800, // slightly longer than default (600ms) animation
                            nodeTemplateMap: myDiagram.nodeTemplateMap,  // share the templates used by myDiagram
                            model: new go.GraphLinksModel([  // specify the contents of the Palette
                                {category: "Start", text: "Start"},
                                {text: "Job"},
//                            {text: "???", figure: "Diamond"},
                                {category: "End", text: "End"}
//                            {category: "Comment", text: "Comment"}
                            ])
                        });
            })
        }
        // Make all ports on a node visible when the mouse is over the node
        function showPorts(node, show) {
            var diagram = node.diagram;
            if (!diagram || diagram.isReadOnly || !diagram.allowLink) return;
            node.ports.each(function (port) {
                port.stroke = (show ? "white" : null);
            });
        }
        // Show the diagram's model in JSON format that the user may edit
        function save() {
            console.log('save')
            document.getElementById("mySavedModel").value = myDiagram.model.toJson();
            myDiagram.isModified = false;
        }
        function load() {
            myDiagram.model = go.Model.fromJson(document.getElementById("mySavedModel").value);
        }
        function showOuterDialog() {
            window.myVue.outerVisible = true
        }
    </script>
</head>
<body onload="init()">
<!--<div onclick="showOuterDialog()">显示外层div</div>-->
<div id="sample">
    <el-dialog title="外层 Dialog" :visible.sync="outerVisible">
        <h3>GoJS Flowchart</h3>
        <div style="width:100%; white-space:nowrap;">
        <span style="display: inline-block; vertical-align: top; padding: 5px; width:120px">
          <div id="myPaletteDiv" style="border: solid 1px gray; height: 500px"></div>
        </span>

            <span style="display: inline-block; vertical-align: top; padding: 5px; width:40%">
          <div id="myDiagramDiv" style="border: solid 1px gray; height: 500px"></div>
        </span>
        </div>
        <button id="SaveButton" onclick="save()">保存</button>
        <button onclick="load()" style="display: none">Load</button>
        <!--Diagram Model saved in JSON format:-->
        <textarea id="mySavedModel" style="width:100%;height:300px;display: none;">
    { "class": "go.GraphLinksModel",
      "linkFromPortIdProperty": "fromPort",
      "linkToPortIdProperty": "toPort",
      "nodeDataArray": [
    {"key":-1, "category":"Start", "loc":"175 0", "text":"Start"},
    {"key":1, "loc":"175 100", "text":"Job"},
    {"key":2, "loc":"175 190", "text":"Job"},
    {"key":3, "loc":"175 270", "text":"Job"},
    {"key":-2, "category":"End", "loc":"175 340", "text":"End"}
     ],
      "linkDataArray": [
    {"from":1, "to":2, "fromPort":"B", "toPort":"T"},
    {"from":2, "to":3, "fromPort":"B", "toPort":"T"},
    {"from":3, "to":4, "fromPort":"B", "toPort":"T"},
    {"from":4, "to":6, "fromPort":"B", "toPort":"T"},
    {"from":6, "to":7, "fromPort":"B", "toPort":"T"},
    {"from":7, "to":8, "fromPort":"B", "toPort":"T"},
    {"from":8, "to":-2, "fromPort":"B", "toPort":"T"},
    {"from":-1, "to":0, "fromPort":"B", "toPort":"T"},
    {"from":-1, "to":1, "fromPort":"B", "toPort":"T"},
    {"from":-1, "to":5, "fromPort":"B", "toPort":"T"},
    {"from":5, "to":4, "fromPort":"B", "toPort":"T"},
    {"from":0, "to":4, "fromPort":"B", "toPort":"T"}
     ]}
      </textarea>
        <el-dialog title="表单" :visible.sync="dialogFormVisible" append-to-body>
            <el-form :model="form" :rules="rules" ref="ruleForm">
                <el-form-item label="任务名称：" :label-width="formLabelWidth">
                    <el-input v-model="form.jobName" auto-complete="off"></el-input>
                    </el-input>
                </el-form-item>
                <el-form-item label="命令语句：" :label-width="formLabelWidth" prop="command">
                    <el-input type="textarea" :rows="3" placeholder="请输入内容" v-model="form.command">
                    </el-input>
                </el-form-item>
                <el-form-item label="上传sh文件：" :label-width="formLabelWidth" prop="shFile">
                    <el-select v-model="form.region" placeholder="请选择活动区域">
                        <el-option label="区域一" value="shanghai"></el-option>
                        <el-option label="区域二" value="beijing"></el-option>
                    </el-select>
                </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button @click="dialogFormVisible = false">取 消</el-button>
                <el-button type="primary" @click="dialogFormVisible = false">确 定</el-button>
            </div>
        </el-dialog>
    </el-dialog>
</div>
</body>
</html>